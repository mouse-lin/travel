<script type="text/javascript" charset="utf-8">
    triggle = { 
        products : <%= @products %>,
        chufas   : <%= @chufas %>,
        destcats : <%= @destcats %>,
        linetypes : <%= @linetypes %>
    }
    originValue = { 
        product : <%= flash[:product].to_json.html_safe %> || triggle.products[0],
        chufa : <%= flash[:chufa_name].to_json.html_safe %> || [],
        linetype : <%= flash[:linetype_name].to_json.html_safe %> || [],
        price : <%= flash[:price].to_json.html_safe %> || [],
        days : <%= flash[:days].to_json.html_safe %> || [],
        destcat : <%= flash[:dest_name].to_json.html_safe %> || []
    }
    jQuery(document).ready(function(){
        //其他选择 -- 彬
        initForm() //启动autocomplete
        search = function () { 
            var result = { 
                type : { product : [] }, 
                search : { chufa_name : [], dest_name : [], linetype_name : [], daystart : [], dayend : [], days : [], price : [] } 
            };

            $(".tilesearch-chufa").find(".tilesearch-result-item").each (function () { 
                result.search.chufa_name.push($(this).text());
            })
            $(".tilesearch-product").find(".tilesearch-result-item").each (function () { 
                result.type.product.push($(this).text());
            })
            $(".tilesearch-destcat").find(".tilesearch-result-item").each (function () { 
                result.search.dest_name.push($(this).text());
            })
            if(result.type.product[0] !== "签证") { 
                $(".tilesearch-linetype").find(".tilesearch-result-item").each (function () { 
                    result.search.linetype_name.push($(this).text());
                })
            }
            if(result.type.product[0] !== "签证") { 
                $(".tilesearch-day").find(".tilesearch-result-item").each (function () { 
                    result.search.days.push($(this).text());
                })
            }
            $(".tilesearch-price").find(".tilesearch-result-item").each (function () { 
                result.search.price.push($(this).text());
            })
            result.search.daystart.push($("#dateStart").val());
            result.search.dayend.push($("#dateEnd").val());

            window.location.href = "homes?" + $.param(result);
        }
        
        callback = { 
            firstclick : function (result) { 
                search();
            },
            secondclick : function (result) { 
                search();
            },
            clear : function () { 
                search();
            },
            remove : function(result, tilesearch) { 
                search();
            },
            save : function (result) {
                search();
            }
        }
        //*/
        /*
        callback = {  };
        //*/

        $(".tilesearch-chufa").tilesearch ({ 
            children : triggle.chufas,
            origin : originValue.chufa,
            select : 1,
            result : function (f_value) { 
                return f_value;
            },
            callback : callback
        });
        $(".tilesearch-product").tilesearch ({ 
            children : triggle.products,
            select : 4,
            hideall : true,
            origin : originValue.product,
            result : function (f_value) {
                return f_value;
            },
            callback : $.extend({  }, callback, { 
                beforeorigin : function () { 
                    if( originValue.product.length > 0 && originValue.product[0] === "签证") {
                        $(".tilesearch-chufa strong").text("送签地:");
                        $(".tilesearch-destcat strong").text("送签国:");
                        $(".tilesearch-linetype").hide();
                        $(".tilesearch-day").hide();
                    }
                    return;
                }
            })
        });
        $(".tilesearch-linetype").tilesearch ({ 
            children : triggle.linetypes,
            select : 2,
            origin : originValue.linetype,
            result : function (f_value) { 
                return f_value;
            },
            callback : callback
        });
        $(".tilesearch-price").tilesearch ({ 
            children : [
                "500以内", "500-1000", "1000-2000", "2000-4000", "4000-10000", "10000以上"
            ],
            select : 1,
            origin : originValue.price,
            result : function (f_value) { 
                return f_value;
            },
            callback : callback
        });
        $(".tilesearch-day").tilesearch ({ 
            children : [
                "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "15天以上"
            ],
            select : 1,
            origin : originValue.days,
            result : function (f_value) { 
                return f_value;
            },
            callback : callback
        });
        $(".tilesearch-destcat").tilesearch ({ 
            children : triggle.destcats,
            select : 3,
            result : function (value) { 
                return value;
            },
            origin : originValue.destcat,
            callback : callback
        });
        var class2 = [ ".tilesearch-product", ".tilesearch-time", ]
        
       // //表格校验开始
       // jGrowl = { open: false };
       // jQuery("#formID").validationEngine();

       // //quickSearchjGrowl(); 
       // //$.Move("quickSearchjGrowlWindow");
    });

    //autocomplete扩展方法
    function autocompleteSearch(dom,url,itemString){
        $(dom).autocomplete(url,{ 
            max:12,
            delay:1,
            dataType: "json",
            parse: function(data) {  
              return $.map(eval(data), function(row) {  
                  return {  
                       data: row,  
                       result: row.name
                    }  
                });
            },  
            formatItem: function(item) {  
                if(!itemString)
                  return   item.name  ;  
                else
                  return itemString;
            },  
        });
    }

    //定义autocomplete函数
    function initForm(){ 
        //日期选择定义
        $("#dateEnd").glDatePicker({
            onChange: function(target, newDate){
                 target.val
                 (
                     newDate.getFullYear() + "-" +
                     (newDate.getMonth() + 1) + "-" +
                     newDate.getDate()
                 );
                 search();
           }
        });

        $("#dateStart").glDatePicker({
            onChange: function(target, newDate){
                target.val
                (
                    newDate.getFullYear() + "-" +
                    (newDate.getMonth() + 1) + "-" +
                    newDate.getDate()
                );
                $("#dateEnd")[0].focus();
           }
        });
        $(".tilesearch-time u").click (function () { 
            $("#dateStart").val("");
            $("#dateEnd").val("");

            search();
        });
        //autocomplete定义标签
        autocompleteSearch("#pifaName","/homes/autocomplete_search.json?model=Pifa");
        autocompleteSearch("#lineName","/homes/autocomplete_search.json?model=Linename");
    }

    /*
    //查询拖放窗口
    function quickSearchjGrowl(){ 
        /* 前台使用快速搜索代码  --> 复制这里的代码可以随时在html.erb中使用
        <%= form_tag "/homes", :id => "quickSearch", :class => "quickSearch", :method => "get" do %>
        产品分类<font  color="red">*</font>：
        <%=text_field :type, :product, :id =>"productS", :class => "validate[required]", :value => flash[:product_type], :size => 20 %><br>
        线路编号：
        <%=text_field :search, :line_number, :id =>"lineNumber",:value => flash[:line_number], :size => 20 %><br>
        品牌编号：
        <%=text_field :search, :pifa_name, :id =>"pifaName",:value => flash[:pifa_name], :size => 20 %><br>
        <button>确定</button>
        <%end%>

        if(!jGrowl.open){  
            var form_start = '<%= form_tag "/homes"  , :id => "quickSearch", :class => "quickSearch", :method => "get" do %>';
        var product = '<%=text_field :type, :product, :id =>"productS", :class => "validate[required]", :hidden => true, :value => flash[:product_type], :size => 20 %><br>'
            var line_name = '线路名称：<%=text_field :quick_search, :line_name, :id =>"lineName",:value => flash[:line_name], :size => 20 %><br>';
            var line_number = '线路编号：<%=text_field :quick_search, :line_number, :id =>"lineNumber",:value => flash[:line_number], :size => 20 %><br>';
            var pifa_name = '品牌编号：<%=text_field :quick_search, :pifa_name, :id =>"pifaName",:value => flash[:pifa_name], :size => 20 %><br>';
            var button='<button>确定</button>';
            var form_end = '<% end %>';

            var title="快速查询";
            var content_string = form_start +  line_number + line_name + pifa_name +  button + form_end;
            return $.jGrowl(content_string,{ 
                sticky: true,
                header: title,
                position: "bottom-right",
                close: function(){ 
                    jGrowl.open = false;
                },
                afterOpen: function(){ 
                    jGrowl.open = true;
                    initForm();
                },
   			   		 nimateOpen: { 
				   		     height: "show",
				   		     width: "show"
				   	   },
            });
        }
    }
    */


</script>
<div class="wrapper col3">
  <div id="homecontent">
      <table>
          <tr>
              <td>
                  <table style='margin:0px;'>
                      <td>
                      <ul class='tilesearch-parent tilesearch-product'>  <strong >产品类型:</strong></ul>
                      <ul class='tilesearch-parent tilesearch-chufa'>    <strong >出发地:</strong></ul>
                      <ul class='tilesearch-parent tilesearch-destcat'>  <strong >目的地:</strong></ul>
                      <ul class='tilesearch-parent tilesearch-linetype'> <strong >线路类型:</strong></ul>
                      <div class='tilesearch-parent tilesearch-time'>     
                          <div style='display:inline;'><span>出团时间起:</span><input readonly id='dateStart' value = <%= flash[:daystart] %>></div>
                          <div style='display:inline;'><span id='tilesearch-end'>出团时间止:</span><input readonly id='dateEnd' value = <%= flash[:dayend]%> ><u>清除</u></div>
                      </div>
                      <ul class='tilesearch-parent tilesearch-day'>      <strong >天数:</strong></ul>
                      <ul class='tilesearch-parent tilesearch-price'>    <strong >价格:</strong></ul>
                      </td>
                  </table>
              </td>
          </tr>
          <tr>
              <td>
                  <div style='clear:both;'>
                      <form action="/homes" class='quickSearch' id="quickSearch" method='get' style='width:initial;border-color:#ccc;'>
                          <table id='quickSearch-table'>
                           <tr>
                            <input id='productS' name='type[quick_product]' hidden=true value= <%= flash[:product_type] %>></input>
                            <td>
                                <label style='width:90px;' >线路名称：</label>
                            </td>
                            <td>
                            <input id='lineName' name='quick_search[line_name]' value= <%= flash[:line_name] %>></input>
                             </td>
                            <td>
                                <label style='width:90px;' >关键字：</label>
                            </td>
                            <td>
                                <input  id='lineNumber' name='quick_search[line_number]' value= <%= flash[:line_number] %>></input>
                            </td>
                            <td>
                                <label style='width:90px;' >批发商：</label>
                            </td>
                            <td>
                                <input id='pifaName' name='quick_search[pifa_name]' value= <%= flash[:pifa_name] %>></input>
                            </td>
                           </tr>
                          </table>
                         <div style="padding-left:800px"> <button>快速查找</button></div>
                      </form>
                  </div>
              </td>
          </tr>
      </table>
        <!--
    <div class="fl_left">
      <div class="column2">
        <ul>
          <li>
            <form id="formID" class="formular" action="/homes">
            <b>详细搜索栏</b><br>
                <table>
                    <tbody>
                        <tr>
                            <td>
                产品分类<font  color="red">*</font>：<input readonly class="search-product"  name="type[product]" id="product" value=<%=flash[:product_type]%> ></input>
                出发地 ：<div class='initial'><input style='display:initial;' class='search-chufa' type="text" name="search[chufa_name]" readonly value=<%= flash[:chufa_name]%> ></input><u>清除</u></div>
                目的地：<div class='initial'><input style='display:initial;' class='search-destcat' type="text" readonly name="search[dest_name]" value=<%= flash[:dest_name]%>></input><u>清除</u></div>
                线路类型：<div class='initial'><input style='display:initial;' class='search-linetype' type="text" readonly  name="search[linetype_name]" value=<%= flash[:linetype_name]%>></input><u>清除</u></div>
              </td>
              <td>
                出团时间起：<input  class="validate[custom[date]]"  id="dateStart" name="search[daystart]" value=<%= flash[:daystart]%>></input>
                出团时间止：<input  class="validate[custom[date]]"  id="dateEnd"   name="search[dayend]"   value=<%= flash[:dayend]%>></input>
                天数：<div class='initial'><input style='display:initial;' class="search-days" type="text" readonly  name="search[days]" value=<%= flash[:days]%>></input><u>清除</u></div>
                价格：<div class='initial'><input style='display:initial;' class="search-price" type="text" readonly  name="search[price]" value=<%= flash[:price]%>></input><u>清除</u></div>
               </td>
              </tr>
            </tbody>
           </table>
                <button>高级搜索</button>
            </form>

          </li>
        </ul>
        <br class="clear" />
      </div>

        -->


      <div class="column2" style='clear:both;'>
      
      <h2>旅游发团搜索结果</h2>
      <% if @results %>
      <ul>
          <% @search_results.each do |r| %>
        <li>
          <div class="imgholder"><a href="#"><img src="/images/demo/794_s.jpg" alt="" /></a></div>
          <% unless r["visatype_name"]%>
            <b>线路名称 ：</b><strong><a href="#"><%=r["line_name"]%></a></strong><br>
            <b>线路编号 ：</b><%=r["id"]%><br>
            <b>出发地 ：</b><%=r["chufa_name"]%><br>
            <b>品牌名称 ：</b><%=r["pifa_name"]%><br>
            <b>天数 ：</b><%=r["days"]%><br>
            <b>星级 ：</b><%=r["star"]%><br>
            <% if r["foods"] %>
              <b>餐食 ：</b><%=r["foods"] %><br> 
            <% end %>
            <%if r["house_name"]  %>
              <b>酒店类型 ：</b><%=r["house_name"] %><br> 
            <% end %>
            <b>有效期起 ：</b><%=r["daystart"]%><br>
            <b>有效期止 ：</b><%=r["dayend"]%><br>
            <b>总位 ：</b><%=r["total"]%>   <b>剩位 ：</b><font color="red"><%=r["left"]%></font><br>
            <b>出发日期 ：</b><%=r["fatuanri"]%><br>
            <b>同行价 ：</b><%=r["tonghang"]%><br>
            <b>直客价 ：</b><%=r["zhike"]%><br>
            <b>线路说明 ：</b><%=r["detail"]%><br>
          <% else %>
            <b>线路名称 ：</b><strong><a href="#"><%=r["line_name"]%></a></strong><br>
            <b>线路编号 ：</b><%=r["id"]%><br>
            <b>送签地 ：</b><%=r["songqiandi"]%><br>
            <b>送签国 ：</b><%=r["songqianguo"]%><br>
            <b>签证类型 ：</b><%=r["visatype_name"]%><br>
            <b>所需资料 ：</b><%=r["document"]%><br>
            <b>所需时间 ：</b><%=r["days"]%>个工作日<br>
            <b>签证说明 ：</b><%=r["detail"]%><br>
            <b>有效期起 ：</b><%=r["daystart"]%><br>
            <b>有效期止 ：</b><%=r["dayend"]%><br>
            <b>同行价 ：</b><%=r["tonghang"]%><br>
            <b>直客价 ：</b><%=r["zhike"]%><br>
          <% end %>
        </li>
        <% end %>
      </ul>
      <div class="digg_pagination">
        <%= will_paginate @results, :container => false, :param_name => "quick_search_page" %>
      </div>
      <%else%>
        没有该类型的发团
      <% end %>
      </div>

    </div>

    <div class="fl_right">

    </div>
    <br class="clear" />
  </div>
</div>
